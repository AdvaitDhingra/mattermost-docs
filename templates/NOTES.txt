{{/* If using self-signed auto-generated certificates */}}
{{- if not (or .Values.global.ingress.configureCertmanager .Values.global.ingress.tls) -}}
WARNING: Automatic TLS certificate generation with cert-manager is disabled and
no TLS certificates were provided. Self-signed certificates were generated.

{{- if (index .Values "gitlab-runner").install -}}
{{- fail "Automatic TLS certificate generation with cert-manager is disabled and no TLS certificates were provided. Self-signed certificates would be generated that do not work with gitlab-runner. Please either disable gitlab-runner by setting `gitlab-runner.install=false` or provide valid certificates." -}}
{{- end -}}
{{- end -}}

{{/*
Deprecation behaviors for global configuration of Minio
*/}}
{{- if ( hasKey .Values.minio "enabled" ) -}}
{{-   fail "minio: chart-local `enabled` property has been moved to global. Please remove `minio.enabled` from your properties, and set `global.minio.enabled` instead." -}}
{{- end -}}
{{- if .Values.registry.minio -}}
{{-   if ( hasKey .Values.registry.minio "enabled" ) -}}
{{-     fail "registry: chart-local configuration of Minio features has been moved to global. Please remove `registry.minio.enabled` from your properties, and set `global.minio.enabled` instead." -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.unicorn.minio -}}
{{-   if ( hasKey .Values.gitlab.unicorn.minio "enabled" ) -}}
{{-     fail "unicorn: chart-local configuration of Minio features has been moved to global. Please remove `unicorn.minio.enabled` from your properties, and set `global.minio.enabled` instead." -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.sidekiq.minio -}}
{{-   if ( hasKey .Values.gitlab.sidekiq.minio "enabled" ) -}}
{{-     fail "sidekiq: chart-local configuration of Minio features has been moved to global. Please remove `sidekiq.minio.enabled` from your properties, and set `global.minio.enabled` instead." -}}
{{-   end -}}
{{- end -}}
{{- if index .Values.gitlab "task-runner" "minio" -}}
{{-   if ( hasKey ( index .Values.gitlab "task-runner" "minio" ) "enabled" ) -}}
{{-     fail "task-runner: chart-local configuration of Minio features has been moved to global. Please remove `task-runner.minio.enabled` from your properties, and set `global.minio.enabled` instead." -}}
{{-   end -}}
{{- end -}}

{{/* Migration of rails `connection` blocks to secrets */}}
{{- if .Values.gitlab.unicorn.lfs.connection -}}
{{-   if without (keys .Values.gitlab.unicorn.lfs.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.unicorn:\n\tThe `lfs.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.unicorn.lfs.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.unicorn.artifacts.connection -}}
{{-   if without (keys .Values.gitlab.unicorn.artifacts.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.unicorn:\n\tThe `artifacts.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.unicorn.artifacts.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.unicorn.uploads.connection -}}
{{-   if without (keys .Values.gitlab.unicorn.uploads.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.unicorn:\n\tThe `uploads.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.unicorn.uploads.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.sidekiq.lfs.connection -}}
{{-   if without (keys .Values.gitlab.sidekiq.lfs.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.sidekiq:\n\tThe `lfs.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.sidekiq.lfs.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.sidekiq.artifacts.connection -}}
{{-   if without (keys .Values.gitlab.sidekiq.artifacts.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.sidekiq:\n\tThe `artifacts.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.sidekiq.artifacts.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if .Values.gitlab.sidekiq.uploads.connection -}}
{{-   if without (keys .Values.gitlab.sidekiq.uploads.connection) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.sidekiq:\n\tThe `uploads.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.sidekiq.uploads.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if index .Values.gitlab "task-runner" "lfs" "connection" -}}
{{-   if without (keys (index .Values.gitlab "task-runner" "lfs" "connection")) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.task-runner:\n\tThe `lfs.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.task-runner.lfs.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if index .Values.gitlab "task-runner" "artifacts.connection" -}}
{{-   if without (keys (index .Values "gitlab.task-runner" "artifacts.connection")) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.task-runner:\n\tThe `artifacts.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.task-runner.artifacts.connection.secret`" -}}
{{-   end -}}
{{- end -}}
{{- if index .Values.gitlab "task-runner" "uploads.connection" -}}
{{-   if without (keys (index .Values.gitlab "task-runner" "uploads.connection")) "secret" "key" | len | ne 0 -}}
{{-     fail "\ngitlab.task-runner:\n\tThe `uploads.connection` declarations have been moved into a secret. Please create a secret with these contents, and set `gitlab.task-runner.uploads.connection.secret`" -}}
{{-   end -}}
{{- end -}}

{{/* Migration of Registry `storage` dict to a secret */}}
{{- if .Values.registry.storage -}}
{{-   $keys := without (keys .Values.registry.storage) "secret" "key" "extraKey" -}}
{{-   if len $keys | ne 0 -}}
{{-     fail "\nregistry:\n\tThe `storage` property has been re-implemented as a secret. Please place the contents of `storage` into a secret, and provide `storage.secret` instead. See documentation." -}}
{{-   end -}}
{{- end -}}
