


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Using Mattermost Operator Functionality &mdash; Mattermost 5.30 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="https://docs.mattermost.com/install/use-kubernetes-mattermost.html" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/myscript.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="search" title="Search" href="../search.html" />
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-K874RWM');</script>
	<!-- End Google Tag Manager -->

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Mattermost
          

          
          </a>

          
            
            
              <div class="version">
                5.30
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/cloud-admin-guide.html">Cloud Administrator's Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/administrator.html">Self-Managed Administrator's Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/user.html">User's Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/integration.html">Integration Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://developers.mattermost.com/">Developer's Guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Mattermost</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          


  


<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
    <li>Using Mattermost Operator Functionality</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/mattermost/docs/blob/master/source/install/use-kubernetes-mattermost.rst" class="fa fa-github"> Edit</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-mattermost-operator-functionality">
<span id="use-kubernetes-mattermost"></span><h1>Using Mattermost Operator Functionality<a class="headerlink" href="#using-mattermost-operator-functionality" title="Permalink to this headline">¶</a></h1>
<div class="section" id="rolling-upgrades">
<h2>Rolling Upgrades<a class="headerlink" href="#rolling-upgrades" title="Permalink to this headline">¶</a></h2>
<p>The Mattermost Kubernetes Operator supports rolling upgrades so you can upgrade
your Mattermost deployment with zero downtime. This process
requires at least two replicas as a rolling upgrade cannot be performed if there is only one pod.
Replicas are created when a user count is selected and exceeds 100.</p>
<p>New Mattermost releases are announced via our community server, as well as social media and email.</p>
<p><strong>Performing rolling upgrades</strong></p>
<ol class="arabic simple">
<li><p>Log in to your Kubernetes instance.</p></li>
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">mattermost-installation.yaml</span></code> manifest (the one created during installation).</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">spec.version</span></code> value to the new version.</p></li>
<li><p>Save the changes.</p></li>
</ol>
<p>Apply the changes with kubectl using</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -n mattermost -f /path/to/mattermost-installation.yaml
</pre></div>
</div>
<p>The operator initiates a job in the Kubernetes cluster and once migration is complete the pods are restarted. If necessary,
a database migration is also performed.</p>
<p>To view information about the running job, use</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl -n mattermost get <span class="nb">jobs</span>
</pre></div>
</div>
<p>At least one pod is available at all times and once all pods are restarted with the new version the upgrade is complete.</p>
<p>To view the status of the pods and to confirm their state, use</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ kubectl -n mattermost get pods
</pre></div>
</div>
<p>The <em>STATUS</em> of the pods should be running/ready, with an <em>AGE</em> of 10-15 seconds.</p>
</div>
<div class="section" id="blue-green-deployments">
<h2>Blue-green Deployments<a class="headerlink" href="#blue-green-deployments" title="Permalink to this headline">¶</a></h2>
<p>Blue-green deployments can reduce downtime and increase stability during automated tasks in a production environment.
This technique entails running two identical production environments in tandem, with one acting as a
live environment and one as an idle environment.</p>
<p>An upgrade can be rolled out to the idle environment (“blue”) while the other (“green”) is the production environment.
Once the upgrade has been successfully rolled out, all traffic can be switched from “green” to “blue”.</p>
<p><strong>Note:</strong> Blue-green can be run on a permanent basis but utilizes more resources in the Kubernetes cluster than normal deployments.</p>
<p><strong>Configuring Blue-green Deployments</strong></p>
<p>Open the <code class="docutils literal notranslate"><span class="pre">mattermost-installation.yaml</span></code> file and add <code class="docutils literal notranslate"><span class="pre">blueGreen</span></code> under <code class="docutils literal notranslate"><span class="pre">spec</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">blueGreen</span><span class="p">:</span>
<span class="nt">enable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">productionDeployment</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="nt">blue</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;version number&gt;</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mattermost/mattermost-enterprise-edition</span>
<span class="nt">green</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;version number&gt;</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mattermost/mattermost-enterprise-edition</span>
</pre></div>
</div>
<p><strong>Parameters</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enable</span></code>. When enabled it ignores the regular <code class="docutils literal notranslate"><span class="pre">spec.version</span></code> and <code class="docutils literal notranslate"><span class="pre">spec.image</span></code>. When set to <code class="docutils literal notranslate"><span class="pre">false</span></code> it is ignored.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">productionDeployment</span></code>. Set to <code class="docutils literal notranslate"><span class="pre">blue</span></code> or <code class="docutils literal notranslate"><span class="pre">green</span></code> to route all users to the specified deployment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image</span></code>.  Optional. Select the image used.</p></li>
</ul>
<p>When the manifest is updated, two new ingresses (proxies) are created at <code class="docutils literal notranslate"><span class="pre">blue.yourmattermosturl.com</span></code> and <code class="docutils literal notranslate"><span class="pre">green.yourmattermosturl.com</span></code>.</p>
<p>To access the new ingresses, create CNAME or IP address records in your DNS registration service for the <code class="docutils literal notranslate"><span class="pre">ingressName</span></code> in your
manifest, pointing to the address you just copied.</p>
<p>For example, on AWS you would do this within a hosted zone in Route 53. Use the required <code class="docutils literal notranslate"><span class="pre">ingressName</span></code> URL in your browser to directly access blue or green at any time.</p>
<p>To update the version of blue or green, change the version in the manifest to
match the current version or the version you’d like to deploy. This
change (regardless of which is the <code class="docutils literal notranslate"><span class="pre">productionDeployment</span></code>) initiates a database migration.
The schema is backwards and forwards compatible across minor versions (from 5.9 onwards) and will not disrupt the production deployment.
However, it will auto-upgrade the database.</p>
</div>
<div class="section" id="canary-builds">
<h2>Canary Builds<a class="headerlink" href="#canary-builds" title="Permalink to this headline">¶</a></h2>
<p>A canary build is used to test an experimental or untested build. It’s similar to a blue-green deployment in that multiple environments
are run simultaneously. However, where blue-green deployments have different URLs, canary builds are set up to direct a random segment of users
to the test environment. Users are not explicitly aware that they’re on the canary build environment.</p>
<p>The redirect is managed with a cookie, which is valid for 24 hours.</p>
<p>The Mattermost Operator currently allows segmenting by percentage (i.e., splitting the user pool between production and the canary build). In
future releases segmentation options will include teams and individual users.</p>
<p>Configuring canary builds requires an update to the <code class="docutils literal notranslate"><span class="pre">mattermost-installation.yaml</span></code> file and the addition of a plugin via System Console. Before
proceeding, first download the <a class="reference external" href="https://github.com/mattermost/mattermost-plugin-canary/releases">Mattermost Plugin for Canary Deployments</a>.</p>
<p><strong>Configuring Canary Builds</strong></p>
<p>Open the <code class="docutils literal notranslate"><span class="pre">mattermost-installation.yaml</span></code> file and add the following under <code class="docutils literal notranslate"><span class="pre">spec</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">canary</span><span class="p">:</span>
<span class="nt">enable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">Deployment</span><span class="p">:</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5.15.0</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mattermost/mattermost-enterprise-edition</span>
</pre></div>
</div>
<p>Next, navigate to <strong>System Console &gt; Plugin Management</strong>, enable plugins, and upload the Mattermost Canary Plugin. Once uploaded, refresh
your page and then select <strong>Settings</strong> from the Canary plugin modal. Enter the percentage of users you’d like to direct to the canary build.</p>
<p>Once complete, navigate to your Mattermost instance and open the Developer Tools menu in your browser. The entry for the Mattermost instance
will display <em>always</em> or <em>never</em> depending on the segment you’ve been allocated to.</p>
<p>You can disable canary builds in the <code class="docutils literal notranslate"><span class="pre">mattermost-installation.yaml</span></code> file by changing the <code class="docutils literal notranslate"><span class="pre">enable</span></code> field to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2015-2020 Mattermost.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  
 




<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-cog">&nbsp;&nbsp;Options</span>&nbsp;
        <span class="fa fa-angle-up"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Contribute</dt>
            <dd>
                <a href="https://github.com/mattermost/docs/issues">Report a Problem</a>
            </dd>
            
            <dd>
                <a href="https://github.com/mattermost/docs/blob/master/source/install/use-kubernetes-mattermost.rst"> Edit on GitHub</a>
            </dd>
            
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
	<header>
	<div class="header__container">
		<div class="search__icon">
			<i class="fa fa-search"></i>
		</div>
		<a href="https://docs.mattermost.com/" class="header__logo">
			<img width="176" src="https://about.mattermost.com/wp-content/uploads/2017/08/Mattermost-Logo-Blue.svg">
		</a>
		<div class="links__icon">
			<i class="fa fa-bars"></i>
		</div>
		<ul class="header__links">
			<li><a href="https://developers.mattermost.com/">Developers</a></li>
			<li><a href="https://mattermost.com/features/">Product</a></li>
			<li><a href="https://mattermost.com/pricing/">Pricing</a></li>
			<li><a href="https://mattermost.com/blog/">Blog</a></li>
			<li><a href="https://mattermost.com/download/">Download</a></li>
			<li><a href="https://mattermost.com/trial/">Trial</a></li>
		</ul>
		<div class="header__searchbar">
			<form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
                <input type="text" name="q" placeholder="Search by keyword" autofocus />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
		</div>
	</div>
</header>
	<script type="text/javascript">
		/* Temporary fix for the search capability. Fix has been committed to the theme's master;
		   however, waiting a new release to the theme.  This fix should remain in place until that
		   time.  sphinx_rtd_theme is current v0.1.10a0. Commit for the fix in the
		   theme can be found at: https://github.com/snide/sphinx_rtd_theme/commit/a5e0e304
		 */
        if(DOCUMENTATION_OPTIONS) {
			DOCUMENTATION_OPTIONS.SOURCELINK_SUFFIX = '.txt'
        }
    </script>


</body>
</html>